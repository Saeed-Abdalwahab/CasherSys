<style>
    td,th{
        text-align:center;
    }
</style>
<div class="col-md-3">
    <div class="portlet light">
        <div class="portlet-title">
            <div class="caption">
                <i class="fa fa-cutlery"></i>قائمه الطعام 
            </div>
            <div class="tools">
                <a href="javascript:;" class="collapse" data-original-title="" title=""> </a>
              
               
           
            </div>
        </div>
        <div class="portlet-body">
            <div id="AllItemsTree" class="tree-demo jstree jstree-4 jstree-default" role="tree" aria-multiselectable="true" tabindex="0" aria-activedescendant="j4_loading" aria-busy="false">
                <ul class="jstree-container-ul jstree-children" role="group">
                    <li id="j4_loading" class="jstree-initial-node jstree-loading jstree-leaf jstree-last" >
                        <i class="jstree-icon jstree-ocl"></i><a class="jstree-anchor" href="#">
                            <i class="jstree-icon jstree-themeicon-hidden"></i>Loading ...
                        </a>
                    </li>
                </ul>
            </div>

        </div>
    </div>
</div>
<div class="col-md-9">
    <div class="portlet light @*box blue-hoki*@">
        <div class="portlet-title">
            <div class="caption">
                <span class="item-box">
                    <span class="item">
                        <span aria-hidden="true" class="icon-basket-loaded"></span> الاوردر
                    </span>
                </span>
            </div>
            <div class="tools">
                <a href="javascript:;" class="collapse" data-original-title="" title=""> </a>



            </div>
        </div>
        <div class="portlet-body">
            <div class="table-responsive">
                <table class="table table-striped" id="OrderTableID">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th style="width:20%">الصنف</th>
                            <th>العيش</th>
                            <th>السعر</th>
                            <th style="width:10%">العدد</th>
                            <th>ملاحظات</th>
                            <th>التكلفه(جنيه)</th>
                        </tr>
                    </thead>
                    <tbody>
                   
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="4">
                                إجمالـــــــــــــي
                            </th>
                            <th class="TotalCountFooter">

                            </th>  
                            <th >

                            </th>
                            <th class="TotalCostFooter">
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script src="~/assets/global/plugins/jstree/dist/jstree.min.js" type="text/javascript"></script>
    <script src="~/assets/pages/scripts/ui-tree.min.js" type="text/javascript"></script>
    <script>
        function ResetTableIndexNumber(TableID) {
            $('#' + TableID + ' > tbody  > tr').each(function (index, tr) {

                tr.children[0].innerHTML = index + 1;
            });
           
            ResetAllCalculationInTable();
        }
        function CalculateFooterTotal() {

            var TotoalCount = 0;
            var TotalOrderCost = 0;
            $('#OrderTableID   tbody   tr  td[class="InputForCount"]').each(function (index, input) {

                TotoalCount += parseFloat($(this).find("input").val());
                TotalOrderCost += parseFloat($(this).parent().children().last().text());

            });
            $("#OrderTableID tfoot tr th[class='TotalCountFooter']").html(TotoalCount)
            $("#OrderTableID tfoot tr th[class='TotalCostFooter']").html(TotalOrderCost)

        }
        function calculateRowTotal() {
            $('#OrderTableID   tbody   tr').each(function (index, Row) {
                debugger
                var PriceForOne = parseFloat($(this).find("td[class='TdDropDownListForPrice'] select option:selected").text());
                var Exstracost = parseFloat($(this).find("td[class='TdDropDownListForLoaf'] select option:selected").attr("pluscost"));
                var Count = parseFloat($(this).find("td[class='InputForCount'] input").val());
                var LastTd = $(this).find("td[class='TdLastColumTotal']");
                var TotalBeforExtraCost = PriceForOne * Count;
                var TotalAfterExtraCost = Exstracost > 0 && !isNaN(Exstracost) ? TotalBeforExtraCost + Exstracost : TotalBeforExtraCost;
                LastTd.text(TotalAfterExtraCost);

            });
        }

        function ResetAllCalculationInTable() {
            calculateRowTotal();
            CalculateFooterTotal();
        }
        $(document).ready(function () {
         
            $(document).on("change", ".TdDropDownListForLoaf select", function () {
                ResetAllCalculationInTable();
            });
            $(document).on("change", ".TdDropDownListForPrice select", function () {
                ResetAllCalculationInTable();
            });
            $(document).on("keyup", ".InputForCount input", function () {
                debugger
                var This = $(this);
                if (parseFloat(This.val()) % 1 === 0) {
                    This.parent().removeClass("has-error");
                    ResetAllCalculationInTable();
                }
                else {
                    toastr.error("عدد الساندوتش يجب ان يكون رقم صحيح", "")

                    This.parent().addClass("has-error");
                }

            });
            $(document).on("change", ".InputForCount input", function () {
                debugger
                var This = $(this);
                if (parseFloat(This.val()) % 1 === 0) {

                    This.parent().removeClass("has-error");
                    ResetAllCalculationInTable();
                }
                else {
                    toastr.error("عدد الساندوتش يجب ان يكون رقم صحيح", "")
                    This.parent().addClass("has-error");
                }

            });
            //Tree
            $('#AllItemsTree').jstree({
                'plugins': ["wholerow", "checkbox", "types"],
                'core': {
                    'data': {
                        'url': '/Order/GetItemsTree',
                        'dataType': 'json',

                    }
                }
            });

            $('#AllItemsTree').on('changed.jstree', function (e, data) {

                var NodeID = data.node.id;

                if (data.action === "deselect_node") {
                    //No children
                    if (data.node.children.length == 0) {
                        $("#OrderTableID tbody tr[id='" + NodeID + "']").remove();
                        ResetTableIndexNumber("OrderTableID")
                    }
                    // have children
                    else {
                        $.each(data.node.children, function (index, Elment) {
                            $("#OrderTableID tbody tr[id='" + Elment + "']").remove();
                            ResetTableIndexNumber("OrderTableID")
                        })
                    }
                }
                else {
                    //No children
                    if (data.node.children.length == 0) {
                        $.ajax({
                            url: "/Order/ItemDetailsRow?ids=" + NodeID,
                            type: "post",
                            success: function (res) {

                                $("#OrderTableID tbody").append(res);
                                ResetTableIndexNumber("OrderTableID")
                            }
                        })
                    }
                    // have children
                    else {
                        $.each(data.node.children, function (index, Elment) {
                            $("#OrderTableID tbody tr[id='" + Elment + "']").remove();

                        })
                        var DatatoSent = { ids: data.node.children };
                        $.ajax({
                            //contentType: "application/json",
                            //dataType: 'html',

                            type: 'POST',
                            url: "/Order/ItemDetailsRow",

                            data: DatatoSent,
                            traditional: true,
                            success: function (res) {

                                $("#OrderTableID tbody").append(res);
                                ResetTableIndexNumber("OrderTableID")
                            }
                        })
                    }
                }




            });

        })
    </script>
}
@section Styles{
    <link href="~/assets/global/plugins/jstree/dist/themes/default/style.min.css" rel="stylesheet" type="text/css" />
}